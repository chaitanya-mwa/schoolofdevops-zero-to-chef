<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Gourav Shah">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Environments - Chef Tutorial</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Environments";
    var mkdocs_page_input_path = "12_environments.md";
    var mkdocs_page_url = "/12_environments/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-36802546-17', 'chef-tutorial.schoolofdevops.com');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Chef Tutorial</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../01_introduction/">Introduction to Chef</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../03_resources_and_recipies/">Resources and Recipes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../04_cookbooks/">Cookbooks</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../05_tdd_with_test_kitchen/">TDD with Test Kitchen</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../06_multi_node_cluster_setup/">Setting up a Multi Node Cluster</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../07_data_driven_cookbooks_attr_templates/">Data Driven Cookbooks</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../08_customizing_community_cookbooks/">Customizing Community Cookbooks</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../09_deployment/">Deploying Sysfoo App</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../10_roles/">Roles</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../11_search/">Search</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Environments</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#chapter-12-creating-configuration-profiles-with-environments">Chapter 12: Creating Configuration Profiles with Environments</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#making-search-more-specific-with-environments">Making search more specific with environments</a></li>
        
            <li><a class="toctree-l3" href="#creating-a-prod-environment">Creating a prod environment</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../13-applying-with-solo/">Chef Solo</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Chef Tutorial</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Environments</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/schoolofdevops/zero-to-chef/edit/master/chapters/12_environments.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="chapter-12-creating-configuration-profiles-with-environments">Chapter 12: Creating Configuration Profiles with Environments</h1>
<p>In this lab we are going to use chef's environment primitive to,
  * Create different configuration profiles. Setup environment specific configurations.
  * Set cookbook versioning constraints. Define cookbook versions to be used in each environment. This way you could limit your experimentation with your own dev env without affecting rest of the environments.
  * Provide isolation in combination with search.  </p>
<h3 id="making-search-more-specific-with-environments">Making search more specific with environments</h3>
<p>In the previous module, we learnt about search, and even incorporated it to auto discover app servers from load balancer. However with the current configurations, the search results will return list of all app servers, irrespective of the environment. We need to make this search specific to the node's environment.</p>
<ul>
<li>Lets update <strong>myhaproxy</strong> recipe accordingly</li>
<li>Path: <em>cookbooks/myhaproxy/recipes/default.rb</em></li>
</ul>
<p>Update the line which uses search to,</p>
<pre><code class="ruby">all_web_nodes = search(&quot;node&quot;, &quot;role:app AND chef_environment:#{node.chef_environment}&quot;)
</code></pre>

<p>Also update the version in the metadata.</p>
<p>Path: <em>cookbooks/myhaproxy/metadata.rb</em></p>
<pre><code class="ruby">version '0.3.0'
</code></pre>

<p>Upload the cookbook</p>
<pre><code class="console">knife cookbook upload myhaproxy                                                                                            
</code></pre>

<h2 id="creating-a-prod-environment">Creating a prod environment</h2>
<ul>
<li>Create a environment file</li>
<li>Path: <em>sysfoo/environments/prod.rb</em></li>
</ul>
<pre><code class="ruby">name &quot;prod&quot;
description &quot;Production Environment&quot;
cookbook &quot;myhaproxy&quot;, &quot;= 0.3.0&quot;
default_attributes({
  &quot;tomcat&quot; =&gt; { &quot;deploy&quot;  =&gt; {
                 &quot;url&quot; =&gt; 'https://11-94848332-gh.circle-artifacts.com/0/tmp/circle-artifacts.6gxaMPh/sysfoo.war'}
              }
})
</code></pre>

<h3 id="uploading-and-exploring-environment">Uploading and exploring environment</h3>
<pre><code>knife environment from file prod.rb   

knife environment show prod
</code></pre>

<h3 id="bringing-nodes-into-the-environment">Bringing nodes into the environment</h3>
<p>From node4 keep watching the haproxy.cfg</p>
<pre><code class="console">watch -n 1 tail /etc/haproxy/haproxy.cfg
</code></pre>

<p>Lets bring in two nodes into prod env</p>
<pre><code class="console">knife node environment set app1 prod
knife node environment set app2 prod                                                                                         
</code></pre>

<p>Keep watching the haproxy config. It should take the two nodes off as the load balancer still belongs to <code>_default env</code>.</p>
<p>Lets bring load balancer into the prod env</p>
<pre><code class="console">knife node environment set lb prod
</code></pre>

<p>See as the LB limits itself to serve only to the app servers in its own environment.</p>
<p>You should also see two differnt versions of the applications running in the two environments vz <strong>production</strong> and <strong>_default</strong>.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../13-applying-with-solo/" class="btn btn-neutral float-right" title="Chef Solo">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../11_search/" class="btn btn-neutral" title="Search"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright @ 2017-2020 Gourav Shah, School of Devops. Some rights reserved. License CC BY-NC-SA</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/schoolofdevops/zero-to-chef/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../11_search/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../13-applying-with-solo/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
